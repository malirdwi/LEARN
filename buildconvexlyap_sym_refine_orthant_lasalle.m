% function [Q,H2]=iterbuildconvexlyap(G,H)
clear all;
format long
 G=[ -1 1 0 0 0 ;
      1 -1 1 0 -1;
      0 0 -1 0 1;
      0 0 1 -1 0;
      0 0 0 1 -1];
 

 
%G=[-1 0 1 0 0  ; 1 -1 0 0 0 ; 0 1 -1 0 0 ; 0 -1 1 -1 1 ; 0 0 0 1 -1 ]
  
%  G=[ -1  0  1  0 ; 
%       1 -1  0  0 ;
%       0  1 -1  0 ;
%       0  0  1 -1 ;
%       0 -1  0  1]
%    
%   
%   G=[-1  1  0  0  0  0  0 0 ;
%       0 -1  1  0  0  0  0 0; 
%       0  0 -1  1  0  0  0 0 ;
%       1  0  0 -1  1  0  0 -1;
%       0  0  0  0 -1  1  0 0 ;
%       0  0  0  0  0 -1  1 0;
%       0  0  0  0  0  0 -1 1 ; 
%       1 -1  0  0  1 -1  0 0 ];
  
  
%   G=[-1 0 0 1; 0 -1 1 0 ; 1 1 -1 -1 ; 1 1 -1 -1]
  
%   G=[-1 0 1 0 ; 1 -1 0 0 ; 0 1 -1 0 ; 0 -1 0 1; 0 0 1 -1; 1 0 0 -1]; %works
%   
%   
%       range=[-2 2];
%   v1=[-1 1 0 0 ]; % v1',v2',v3' the basis of null space of [1 1 1 1]
% v2=  [-1 0 1 0];
% v3=[-1  0  0 1];
% G=[ randint(1,1,range)*v1+randint(1,1,range)*v2+randint(1,1,range)*v3;
%     randint(1,1,range)*v1+randint(1,1,range)*v2+randint(1,1,range)*v3;
%     randint(1,1,range)*v1+randint(1,1,range)*v2+randint(1,1,range)*v3;
%      randint(1,1,range)*v1+randint(1,1,range)*v2+randint(1,1,range)*v3;];
%  
%  
%  v1=[  -1     1     0     0     0];
%  v2=[0     0    -1     1     0];
%  v3=[0     0    -1     0     1];
%  G=[ randint(1,1,range)*v1+randint(1,1,range)*v2+randint(1,1,range)*v3;
%     randint(1,1,range)*v1+randint(1,1,range)*v2+randint(1,1,range)*v3;
%     randint(1,1,range)*v1+randint(1,1,range)*v2+randint(1,1,range)*v3;
%      randint(1,1,range)*v1+randint(1,1,range)*v2+randint(1,1,range)*v3;];
%  G=[   1    -1     1     0    -1
%      2    -2     4    -2    -2
%      0     0     2    -2     0
%     -2     2    -4     2     2];

%       G=[     0     1     2    -3
%             -8     3     2     3
%              0    -1     1     0
%              1     2    -3     0];
 
%  G=    [1 -1 0 0
%          1 -1 1 -1
%          0 1 0 -1];
%      
%      G=[    -1     0     1     1     0    -1
%     -1    -1     0     1     1     0
%      0    -1    -1     0     1     1
%      1     0     0    -1     0     0
%      0     1     0     0    -1     0];
%  
%    G=[   -1     0     2     1     0    -2
%           -1    -1     0     1     1     0
%            0    -1    -1     0     1     1
%            1     0     0    -1     0     0
%            0     1     0     0    -1     0];
% 
%     G=[ -1 -1 0 0 0 1 0; -1 0 -1 0 0 0 1; 0 1 -1 -1 0 0 0; 0 0 -1 1 -1 0 0]'; G=[G -G];
%  G=[ 2  -2
%      -1  2];
%  
%  G=[ -1  2
%      1 -1
%      1 -1];
%  
%   G=[-1 1 -1 2 ; 0 1 -1 0 ; 1 -1 0 0 ; 0 0 1 -1];
%  G=[ 
%      -1  2   -1       1
%      0   0    2      -2
%      1  -1    0      0    
% ]; 
%  
%  G= [ -1   2  -1
%        0   0  -1
%        1  -1  0  ];
% G=[ -1  0  1  0  0 ;
%      1 -1  0  0  0 ;
%      0  1 -2  1  0 ;
%      0  0  0 -1  1 ;
%      0  0  1  0 -1];    
%  
%  G=[-1 1 0 ; 1 -2 1 ; 0 1 -1];
%    
% G=[ -1  2   -1
%     1   -1   0
%     -1  0    2];
% G=[ -1  1     1
%     0   1    -2
%     1   -1    0  ];
% 
% G=[ -1  2  -1   1
%     0   0   2  -2
%     1  -1   0  0  ] ;
% 
% G=[ -1  2  -1   1
%     0   0   1  -1
%     0   0   1  1
%     1  -1   0  0  ] ;
% 
% 
% G= [ -1 0 1 
%       1 1 -1
%       2 -2 0]';
%   
%  G= [ 0 -1 1 0;
%       1 1  -1 0;
%       -2 0 0 1 ;
%       1  1 0 -1]';
%   
%   G= [ -1 0 1 0
%         1 1 -1 0
%         -1 1 0 1
%         2 0 0 -1]';
%     
%     
%     G=[2 -1 0 ;
%        -2 0  1  ;
%        1  1  -1 ]';
%     
 
%  G=[   -1     0     1     0
%      1    -1    -1     1
%      1    -1    -1     1
%      0     1     0    -1]
% %  
%  G=[   -1 -1 -2; -1 1 0 ; 1 0 1]; G=[G -G];
%   G=[ -1 -1 2; -2 -1 3]'; G=[G -G];
%     G=[ -2 1 1 ; 1 -2 1 ; 1 1 -2] ; % G=[G -G];
% G=[-1 1 0; 1 -2 1; 0 1 -1];
% G=    [1     0     1    -2
%      0    -1     1     0
%      0     1    -1     0];
%   G=[ -1  1  0   0
%       -1  0  2  -1
%        1  0 -1   0 ];
%     G=[   -1     0     1     1     0    -1
%           -1    -1     0     1     1     0
%            0    -1    -1     0     1     1
%            1     0     0    -1     0     0
%            0     1     0     0    -1     0
%            
%            ];
% 
% G=[    -1     1     0     0     0
%      0    -1     1     0     0
%      0     1    -1     0     0
%      1     0    -1    -1     1
%      0     0     0     1    -1];
 
%     G= [ 1 0 -1 0 0 0 ; -1 1 0 0 0 0 ; 0 -1 1 1 -1 0 ; 0  0 0 -1 0 1 ; 0 0 0 0 1 -1];

%   G=[ -1 1 0 ; 1 -2 1 ; 0 1 -1] %
%   G=[-1 1 0 0 0 0 ; 1 -1 0 0 0 0 ; 0 1 -2 1 0 0 ; 0 0 1 -2 1 0 ; 0 0 0 0 -1 1 ; 0 0 0 0 1 -1];

%   G=[-1 1 0 0 0; -1 0 1 0 0 ; 0 -1 0 1 0 ; 0 0 -1 0 1]; %double mtns counter exmaple
% %  G=[-1 1 0 0 ; -1 0 1 0 ; 0 -1 0 1 ; 0 0 -1 1]; %%double mtns counter exmaple with one inflow
% %         G=[-1 1 0 ; -1 0 1];
% 
% G=[-1 1 -1 1;-1 1 1 -1 ; 1 -1 0 0 ]; %% A+B <> C, A<>B
% % G=[  -1    -2     3
% %      0     1    -1];
% G=[-1 1 0 0 -1 ; 1 -1 1 0 0 ; 0 0 -1 1 0 ; 0 0 0 -1 1]
% G=[-2 1 0 0 ; 1 -1 1 0 ; 0 0 -1 1 ; 1 0 0 -1];
% 
% 
% G=[-1 -1 1; 1 1 -1]';
% 
% 
% G =[   -1     1    -1     1     0     1
%         2    -2     0     0     1    -1
%         0     0    -1     1     0     1
%         0     0     1    -1    -1     0
%         0     0     0     0     1    -1]; % fienberg deficiency zero example
%     
%     
  G=[-1     1     0     0     0     0     0     0     0     0     0     1
     0     0     1    -1     1     0     0     0     1    -1     1     0
     0     0     0     0     0     1    -1     1     0     0     0     0
    -1     1     1     0     0     0     0     0     0     0     0     0
     0     0     0    -1     1     1     0     0     0     0     0     0
     0     0     0     0     0     0    -1     1     1     0     0     0
     0     0     0     0     0     0     0     0     0    -1     1     1
     1    -1    -1     0     0     0     0     0     0     0     0     0
     0     0     0     1    -1    -1     0     0     0     0     0     0
     0     0     0     0     0     0     0     0     0     1    -1    -1
     0     0     0     0     0     0     1    -1    -1     0     0     0]; %phosphorylation with separated enyzymes-- S0 S1 S2 E F ES0 ES1 FS1 FS2
%  
%  
%  G=[2 1 -3; 0 1 -1 ; 2 0 -2];
%  G=[-2 -1 3; 0 -1 1; -3 1 2];
%     G=[ -1  0  0 -1  1  0;
%      %    1  0  0  1 -1  0;
%          0  1  0  1 -1  0;
%          0 -1  0 -1  0  1;
%      %    0  1  0  1  0 -1;
%          0  0  1  1  0 -1;
%          0  1 -1  0  0  0;
%          1 -1  0  0  0  0]' ; % S0 S1 S2 E ES0 ES1 --- simplfied double futile
     
  %   G=[-1 0 0 0 0 1 ; 1 -1 0 0  0 0 ; 0 1 -1 0 1 -1 ; 0 0 1 -1 0 0 ; 0 0 0 1 -1 0 ; -1 1 -1 1 0 0 ];  %% SIMPLIED DOUBLE FUITILE >> ALTERNATIVE ORDER
%G=[2 -2 1 0 -1 0; -1 2 0 1 0 -1]  %% small multistable

 %  G=-[-1 1 0 ; 1 -2 1 ; 0 1 -1];  
%  G=[  -1     0     0     2     1     0     0    -2
%       -1    -1     0     0     1     1     0     0
%        0    -1    -1     0     0     1     1     0
%        0     0    -1    -1     0     0     1     1
%        1     0     0     0    -1     0     0     0
%        0     1     0     0     0    -1     0     0
%        0     0     1     0     0     0    -1     0]; % Cr-F big
 

%G=[ -1 -1 0 1 0 ;  1  1 0 -1 0 ; 0 -1 -1 0 1 ; 0  1  1 0 -1 ;-2 0 1 0 0 ; 2 0 -1 0 0]';    % Cr-F small
% % % 
% %  G=[-1 -1 1 ; 0 1 0 ; 1 0 0]'; G=[G -G];
% %  
% %  G=[-1 -1 1 ; 1 0 -1 ; 0 1 0 ; 1 0 0]'; G=[G -G];  % exclude 3,4 and 4,8
%   G=[-1 -1 1 ; 1 1 -1 ; 2 0 -1 ;-2 0 1 ; 0 1 0 ; 0 -1 0 ; 1 0 0; -1 0 0 ]'; 
%   G=[-2 -1 1 ; 2 1 -1 ; 3 0 -1 ;-3 0 1 ; 0 1 0 ; 0 -1 0 ; 1 0 0; -1 0 0 ]'; 
% %  
% %  G=    [-1     1           1     1    -1         -1
% %              -1     0           0     1     0          0
% %               1    -1           0    -1     1          0];
%      G=[1 -1 0;
%        -1 2 -1;
%         0 -1 1;
%         ];
%     G=[ -1 1 1 -1 0 ; 1 -1 -2 2 1 ; 0 0 1 -1 -1];
%  G=[     0     1    -1     0;
%         -1     1    -1     1;
%         -1     0     1     0];
%      G= [1 -1 0  0
%          1 -1 1 -1
%          0  1 0 -1];
% %      
%      
%      G= [1 -1   0
%          2 -1  -1
%          0  1  -1];
   %  load lyapQ
%      
% 
% G=[   -1     1     0     0     0     0     0
%      1    -1     0     0     0     0     0
%      0     0    -1     1     0     0     0
%      0     0     1    -1     0     0     0
%      1     0     1     0    -2     0     0
%      0     0     0     0     1    -2     1
%      0     0     0     0     0     1    -1];
%     
%  
%  G=[-1 1 0 ; -1 0 1 ];
%  G=[ -1 -1 0 1 0 ;  1  1 0 -1 0 ; 0 -1 -1 0 1 ; 0  1  1 0 -1 ;-1 0 1 0 0 ; 1 0 -1 0 0]'; % Cr-F
%  G=[ 1 0   -1 0
%      1 1  -1 -1
%      0 0   1 -1];

%   G=[ 1         1        -2     0     0
%       0         0         1    -2     1
%       0         0         0     1    -1]; % mtns counter with no inflows no outflows -- reduced
%    G=[-1 -1 2 ; 1 -2 1 ; 0 1 -1];  %% ANGELI'S BOOKCHAPTER EXAMPLE 0
  %  G= [-1 1 0 ; 1 -2 1 ; 0 -1 1 ];
 %  G=[-2 0 0 1 1 ; 1 -1 1 -1 0 ; 0 1 -1 0 0 ; 1 -1 0 0 0 ; -1 1 0 0 0; 0 0 0 1 -1  ]; %%% PARAMETER DEPENDENT PERSISTENCE --- MODIFIED
%  G=   [ -1    -1     1     1
%      1    -1     0     0
%      0     1    -1     0
%      0     0     1    -1
%     -1     0     0     1] ; %% EXAMPLE FROM  PETRI NET PAPER
%G=[1 -1 0 0 ; -1 0 1  0 ; 0 1 -1 0 ; 0 -1 0 1; 0 0 1 -1]; 
%G=[-1 1 0  0 ; 0 0 1 -1 ;  0 1 -1 0 ];
% G=[1 0 -1 ; 0 1 -1; 1 1 -2];
% G=[ -1 1 0 ; 0 -1 1; 1 0 -1; 1 -1 0];clc


%G=[-1 1 0 ; 1 -2 1 ; 0 1 -1]

% G=[-1 0 1 ; 1 -2 1 ;  0 1 -1;1 0 -1 ];
%  
% G=[    -1     1    -1    -2     3
%         0     0     1    -1     0
%         0     0     0     1    -1];
% G=[         -1    -2     3 -1 1 
%              1    -1     0  0  0 
%              0     1    -1 0  0]  ; 
 
% G=[-1 0 1 ;
%     1 -2 1;
%     1 0 -1;
%     0 1 -1 ];
% 
% 
% G=[-1 0 1    ;
%     1 -2 1  ;
%     1 0 -1  ;
%     0 1 -1  ];

% G=[-1 1 0 0 ; 
%     1 -1 -1 1 ;
%     0  0  1 -1]

% 
% G=[    -1     0     1   1 -1
%        -1     1     0   0  0
%         1    -1     0   0  0 
%         0     1    -1   0  0 ]
    
%     G=[    -1     0     1    
%        -1     1     0   
%         1    -1     0     
%         0     1    -1     ]
% 
% 
%  G=[    1 -2  1 -1 1 ;
%        -1  1  0  0 0 ;
%         0  1 -1  0 0 ];
 
%  G=[ -1 0 0 1 -1 1 ; 1 -1 1 -1 0 0 ; 0 1 -1 0 0 0 ; 1 -1 0 0 0 0 ; -1 1 0 0 0 0 ; 0 0 0 0 1 -1];
%  
%  
%  
%   
%  G=[-1  1  0  0 % 1  -1;
%     -1  0  0  1 % 0   0;
%      0  1 -1  0 % 0   0;
%      0  1  0 -1 % 0   0;
%      0  0  1 -1 % 0   0;
%      1 -1  0  0 % 0   0;
%     % 0  0  0  0 %-1   1; 
%      ]
%  
%  
%  
%      G=[-1     1     0   0   0
%          1    -1    -1   1   0
%          0     0    -1   0   1
%          0     0     0   1  -1
%          0     0     1  -1   0]   
%      
%      
%      % 
%          G=[  1 -1  1  0 -1;
%               0  0 -1  0  1;
%               0  0  0  1 -1]; %SIMPLIFIED DEVIL
%     
%  
%           G=[-1 0 1 0 ; 2 -1 -1 0 ; 0 -1 0 1];
%           
%           
%              G=[-2 -1 3; -1 -1 2];
%              
%              G=[ 2 -1 0 -1 ; 0 1 -1 0 ; 0 1 0 -1]


G=[-1 -1 1 0 0 0 ; 1 1 -1  0 0 0; 0 1 -1 1 0 0 ; 0 0 0 -1 -1 1  ; 0 0 0 1 1 -1 ; 1 0 0 0 1 -1]'; % phosphorylation S0 E1 S0E1 S1 E2 S1E2 
          

G=[-1 1 0 0 ; 0 -1 1 0 ; 1 0 -1 0 ; 0 0 1 -1 ; -1 0 0 1]

G=[-1 1 0 -1 0 1 ; 0 -1 1 0 0 0 ; 1 0 -1 0 0 0 ; 0 1 -1 -1 1 0 ; 0 0 0 1 -1 0 ;0 0 0 0 1 -1 ];


G=[-1 0 -1 0 1 0 0 0 ; 0 0 0 0 -1 1 0 0 ; 0 1 1 0 0 -1 0 0 ; 0 -1 0 -1 0 0 1 0 ; 0 0 0 0 0 0 -1 1 ; 1 0 0 1 0 0 0 -1]'; % phosphorylation double processive


G=[ -1 -1 1 0 0 0; 0 0 -1 1 0 0 ; 0 0 0 -1 1 0 ; 0 0 0 0 -1 1 ; 1 1 -1 0 0 0; 1 1 0 -1  0 0 ; 1 1 0 0 -1 0; 1 1 0 0 0 -1     ]' 
 %G = [-1  1 1  0 ;
  %    -1  1 1  0;
   %    1  -1  -1  0 ;
   %    0   0  1 -1 ];
 %G=G(1:5,1:4)
 
 G=[-1 0 0 1 ; 0 1 -1 0 ; 1 -1 0 0 ; 0 0 1 -1 ; -1 1 0 0 ; 0 0 -1 1]
 
   G=[-1 1  0 0 ; 1 -1 -1 1 ; 0 0 1 -1]
   
   G=[-1 -1 0 0 1 1 ;
       1 0 0 0 -1 0 ;
       0 1 0 0 0 -1 ;
       0 0 1 1 -1 -1 ;
       0 0 -1 0 1 0 ; 
       0 0 0 -1 0 1]
   
      G=[-2  0 0 1 1 ;
          1  0 0 -1 0 ;
          1  0 0 0 -1 ;
          0  1 1 -1 -1 ;
          0  -1 0 1 0 ; 
          0  0 -1 0 1]
      
      G=[1 -1 0 ; 0 1 -1 ; -1 1 0; 0 -1 1]
      
      
 G=[          1    -1     0     0
    -1     1     0     0
     0     1    -1     0
     0    -1     1     0
     0     0     1    -1
     0     0    -1     1
]


 
 G=[    -1     0    -1     0     1     0     1     0
     0    -1     0    -1     0     1     0     1
    -1    -1     0     0     0     0     1     1
     1     0     0    -1     0     1    -1     0
     0     1    -1     0     1     0     0    -1
     0     0     1     1    -1    -1     0     0];
 
      G=[-1     0    -1     0     1     0     1     0  0
              0    -1     0    -1     0     1     0     1  0
             -1    -1     0     0     0     0     1     1  1
              1     0     0    -1     0     1    -1     0 -1
              0     1    -1     0     1     0     0    -1  0
              0     0     1     1    -1    -1     0     0  0]
          
          
          
              
          G=[-1     0    -1     0     1     0     1     0   0  0  0  0
              0    -1     0    -1     0     1     0     1   0  0  0  0
             -1    -1     0     0     0     0     1     1   0  0  0  0
              1     0     0    -1     0     1    -1     0   0  0  0  0
              0     1    -1     0     1     0     0    -1   0  0  0  0
              0     0     1     1    -1    -1     0     0  -1  1  1  0
              0     0     0     0     0     0     0     0  -1  1  0  1
              0     0     0     0     0     0     0     0   1 -1 -1  0 
              0     0     0     0     0     0     0     0   0  0  1 -1] 
                    G=   [ -1     0     0     0     1     0     0     0
    -1     0     0     0     0     0     1     0
     1    -1     0     0     0     0     0     0
     0     1    -1     0    -1     1     0     0
     0     1    -1     0     0     0    -1     1
     0     0     1    -1     0     0     0     0
     0     0     0     1     0    -1     0     0
     0     0     0     1     0     0     0    -1] %double phosphotransfer
 
G=[1 -1 0 ; -1 2 -1 ; 0 -1 1 ] 
  H=[G;
      % 1 -1 0 0 0 ; 0 0 1 -1 0 ; 1 -1 0 1 -1; 1 -1 0 -1 1;
   %   0 1 0 0 -1 0 
    %     0 -1 0 1
  %    0    -1    -1     0     1     1
  %    0    -1     0     0     1     0

  
   %    0     1    -1     1     0    -1     1    -1
    %   0     1    -1     0     0    -1     1     0

    %   0    -1     1     0     1    -1
    %   0     0     1     0     0    -1
%  
%  
   %   0     1     0     0    -1     0    
      %    0     0     0     1     0     0     0    -1
   %  0     1     0     1     0    -1     0    -1

  %1 0  0 0 -1
        %0 1  0 0 -1
        %1 0 -1 0  0
       % 0 1 -1 0 0
%             1     -1    0     1    -1
 %1     -1     0     -1   1 %%
  %      1     -1    1    -1    0
%            1     0     0   0      0    -1
%            0     1     0   0      0    -1
%            0     0     1   0      -1    0
%            0     0     0   1      -1    0
          %  0     0    -1     0     0     1 % for the Cr-Fein example
     %     0 0  0 0 1 -1% for the Cr-Fein example ??
%    1     0    -1     0     0     0
%      0    -1     1     0     0     0
%      0    -1     0     1     0     0
%      1     0     0     0    -1     0
%      1     0     0     0     0    -1
 %     0    -1     0     0     0     1
%      1    -1     0     0     0     0
%      0     0    -1     1     0     0
%      0     0    -1     0     1     0
%      0     0    -1     0     0     1
%      0     0     0    -1     1     0
%      0     0     0    -1     0     1
%      0     0     0     0    -1     1
% 1 0 0 -1;
% 0 0 1 -1;
%     1     -1    0     1    -1
%    % 1     -1     0     -1   1 %%
%        1     -1    1    -1    0
%        -1 1 1 -1 0
       
%  -1 0 2 -1
%   1 -2 0 1
%   2 -1 -1 0
%   0 -1 -1 2
%        
%            0     0    -1 -1 2
%          1 -1 1 -1 0
%         1 -1 0 1 -1
%    -1    0     0    1
     %-1    0     1    0
%      0    0     1   -1
   %  1    0     1   -2
    % -1    2    -1    0

 %   -2     0     1     1
 
% 1 -1 0 0
    
%       0 1 -1 0
%      0 0 1 -1
%      1 0 0 -1
   ];


     
%      1    0     1   -2
%      0    0     1   -1
%     -1    0     1    0
%   
%     -1    2    -1    0
%    
%    
%     -1    0     0    1
%     -1    0    -1    2


V=null(G,'r');
 


[n r]=size(G);
[ne r]=size(H);
S=[0:2^ne-1]';
S= 2*(double(dec2bin(S))-48-0.5);

S1=[];
j=1;jj=1;
for i=1:2^ne   %%% REMOVING INCONSISTENT SYSTEM OF INEQUALITES
   
 [x,y,flag]=linprog(zeros(1,r),-diag(S(i,:))*H,-1e-5*ones(ne,1),[],[],zeros(r,1),[],[]);
 if(flag>0)
     S1(j,:)=S(i,:);
    j=j+1;
 else
     S2(jj,:)=S(i,:);
     jj=jj+1;
 end
end
%S1=S; %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"!!!!!!!!!!!!!!!!%%%%%%%%%%
[m ne]=size(S1);
%%%%%%%%% CHECK SYMMETRY
if(mod(m,2)>0)
     error('Symmetry Fails');
else
for j=1:m/2
    if(max(abs(S1(j,:)+S1(m+1-j,:)))>0)
       error('Symmetry Fails');
    end
end
end
disp('Symmetry is Fine');

%%%%%%%%% REFINING THE PARTITIONS



C=[];
r0=[];
for j=1:m  %%% EXCLUDING RATES WITH MULTIPLE CONFLICTING INPUTS
   
    for l=1:r
        In=abs(min([zeros(n,1) G(:,l)]')).*S1(j,1:n);
        if(max(In)*min(In)<0)  %be careful from zero!
            C(j,l)=0;
            if(length(find(r0==l))==0)
                r0=[r0 l];
            end
        elseif(max(In)>0)
            C(j,l)=-1;
            if(length(find(r0==l))==0)
                r0=[r0 l];
            end
        elseif(min(In)<0)
            C(j,l)=1;
            if(length(find(r0==l))==0)
                r0=[r0 l];
            end
        else
            C(j,l)=NaN; %%reaction with no inputs
            
            
        end
    end
    
        
end
 
C
S1
s=length(find(C>0));
q=sym('q',[s 1]);

C
%xx=input('enter .. ');
[Z,Z1,Zx,Z1v]=RegNbhd(S1,H);


[x y]=find(C==0);
E=[];
for i=1:length(x)
     
    E=[E  diag(S1(x(i),:))*H(:,y(i))];
    
end

null(E','r')'


Z2=Z1;
  cvx_begin
variable Q(m,r)
variable L(m,ne)
variable L0(m,r)
variable L2(m,ne,m)

minimize(sum(sum(L)))
% for j=1:m/2
%     Q1(j,:)=-Q0(0.5*m+1-j,:);
% end
% Q=[Q0;Q1];
 
subject to
% sum(Q(:,4))>1e-4
uy=[ 1:m/2     ];% 4 5 6  8
uy=[uy m+1-wrev(uy)];
Q(uy,r0).*C(uy,r0)>=0;  %%% to have descreasing function
% 
for j=uy
    for l=1:r
        if(C(j,l)==0)
            Q(j,l)==0;   %% zeros what have to be zeroed
        end
    end
end 
%Q(4,4)>1e-4;
%  Q(6,:)==Q(6,1)*[1 -1 0 0];
% Q(5,:)==Q(5,1)*[1 -1 0 0];
% Q(9,:)==Q(5,1)*[1 -1 0 0];whos S1
%Q(1,1)==0;
%Q(1,2)==0;
%Q(3,3)==0;
%Q(7,3)==0;
%Q(10,4)==0;
%Q(11,1)==0;

 Q*V==0;   % Kernel of the function must be subset of the ketnel of G
 L>=0;
% L2>=0;
 %L2(:,:,7)<0;
L0==0; %%%%%%%%%%%!!!!!!!!!!!!!!!!
 %L2(4,4,1)<-1e-3;
%               L(1,4)==0;
%                L(4,4)==0;
%                L(21,4)==0;
%                L(24,4)==0;
%sum(sum(L))>1;
for j=1:m
    
%  L(5,1:2)==[0 0];
%  L(12,1:2)==[0 0];
    %%% nonnegativity 
       sum(L(j,:))+sum(L0(j,:))>2;
     %  Q(1,1)==1;
%  Q(1,1)==1;
%  Q(1,2)==3;
  %Q(1,2)==1;
   Q(j,:)== L(1,:)*diag(S1(j,:))*H+L0(j,:); 
%        L(1,2)==1;
% L(1,1)==2;
% L(2,1)==2;
% L([7 9:15],1)==2*ones(8,1);
% L([3 6 16 18 19 22 23],1)==2*ones(7,1);
% L([ 4 5 8 17 20 21 24],1)==2*ones(7,1);

        %    Q(j,:)== L(1,1)*[ 2 2 1 1 ]*diag(S1(j,:))*H+L0(j,:); 
 %%%symmetry   
     if(j<=m/2)
         Q(j,:)==-Q(m-j+1,:);  
     end
     %%%%%% continu9ety  covexity
     ex=[       ];
   ex=[ex wrev(m+1-ex)];
     Z2(:,ex)=0*Z2(:,ex);
     Z2(ex,:)=0*Z2(ex,:);
     
     %%%%%%%%%
     
     % Z2(6,9)=1; 
     %  Z2(8,9)=1;
     %  Z2(9,18)=1;
     
     %    Z2(2,4)=1; %Z2(25,26)=1;
       % Z2(3,4)=1; %Z2(20,26)=1;
     %   Z2(4,8)=1;% Z2(2,26)=1;
 %Z2(1,2)=1;
% Z2(1,3)=1;
 % Z2(3,7)=1; 
    %Z2(3,4)=1;
  %  Z2(1,5)=1;
     
             
  
    for j2=j+1:m
        
     
    
        bb=find(abs(sign(S1(j,:)-S1(j2,:)))>0);
      %   if(Z2(j,j2)==1)
          (Q(j,:)-Q(j2,:)) == L2(j2,bb,j)*diag(S1(j,bb))*H(bb,:);
 
   %      (Q(j,:)-Q(j2,:)) == L2(j2,:,j)*diag(S1(j,:))*H(:,:);
%              if(rand>0.95)
%                  1
%                  L2(j2,bb,j)<-1e-3;
          %    end
             P=null(H(bb,:));
              if(length(P)>0)
         %      (Q(j,:)-Q(j2,:))*P==0;
              end
        
            
    end
    end

cvx_end 

full([Q])%/min(abs(Q(find(Q))))
null(Q,'r')


for k=1:m
    B(k,:)=L(k,:)*diag(S1(k,:));
end


 save('lyapQ','G','Q','H','L2','S1','Zx')
 min(L2(find(L2)))